<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pikachu Game</title>
    <link rel="icon" href="images/icon.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Fredoka', Arial, sans-serif;
            background: url("https://i.etsystatic.com/36166354/r/il/e8f61f/4356911410/il_1588xN.4356911410_8di6.jpg") no-repeat center center fixed;
            background-size: cover;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative;
            overflow-x: auto;
        }


            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
                pointer-events: none;
                z-index: -1;
            }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5);
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

            .container::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: conic-gradient(from 0deg, transparent, rgba(255, 215, 0, 0.1), transparent);
                animation: rotate 10s linear infinite;
                z-index: -1;
            }

        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        h1 {
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            margin-bottom: 20px;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        #controls {
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
        }

        #timer, #score {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            padding: 12px 20px;
            border-radius: 25px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            min-width: 120px;
        }

        #gameBoard {
            border: 4px solid transparent;
            border-radius: 20px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%), linear-gradient(45deg, #ff9a9e, #fecfef, #fecfef, #ff9a9e);
            background-origin: border-box;
            background-clip: content-box, border-box;
            margin: 15px auto;
            cursor: pointer;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1), 0 0 20px rgba(255, 255, 255, 0.3), inset 0 2px 10px rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
        }

            #gameBoard:hover {
                transform: translateY(-2px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 30px rgba(255, 255, 255, 0.4), inset 0 2px 10px rgba(255, 255, 255, 0.5);
            }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        #startBtn, #pauseBtn, #restartBtn {
            padding: 15px 25px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Fredoka', Arial, sans-serif;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        #startBtn {
            background: linear-gradient(135deg, #73f17f 0%, #10b60d 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        #pauseBtn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        #restartBtn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

            #startBtn:hover, #pauseBtn:hover, #restartBtn:hover {
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 15px 25px rgba(0, 0, 0, 0.2);
            }

            #startBtn:active, #pauseBtn:active, #restartBtn:active {
                transform: translateY(-1px) scale(1.02);
                box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            }

        #startBtn:disabled, #pauseBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #startBtn::before, #pauseBtn::before, #restartBtn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
            z-index: 0;
        }

        #startBtn:hover::before, #pauseBtn:hover::before, #restartBtn:hover::before {
            width: 300px;
            height: 300px;
        }

        #startBtn span, #pauseBtn span, #restartBtn span {
            position: relative;
            z-index: 1;
        }

        #result {
            display: none;
        }

        /* Hiệu ứng sparkle */
        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            animation: sparkle 1.5s linear infinite;
        }

        @keyframes sparkle {
            0% {
                opacity: 0;
                transform: scale(0);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2em;
            }

            #controls {
                flex-direction: column;
                gap: 10px;
            }

            .btn-group {
                width: 100%;
            }

            #startBtn, #pauseBtn, #restartBtn {
                flex: 1;
                min-width: 0;
                padding: 12px 20px;
                font-size: 14px;
            }

            #timer, #score {
                font-size: 16px;
                padding: 10px 15px;
                min-width: 100px;
            }
        }

        /* Thêm hiệu ứng glow cho canvas */
        @keyframes glow {
            0%, 100% {
                filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
            }

            50% {
                filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.6));
            }
        }

        #gameBoard {
            animation: glow 3s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌟 Super Pikachu 🌟</h1>
        <div id="controls">
            <div class="btn-group">
                <button id="startBtn" onclick="startGame()"><span>Bắt đầu</span></button>
                <button id="pauseBtn" onclick="pauseGame()" disabled><span>Tạm dừng</span></button>
                <button id="restartBtn" onclick="restartGame()"><span>Chơi lại</span></button>
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <div id="timer">⏰ Thời gian: 0s</div>
                <div id="score">🎯 Điểm: 0</div>
            </div>
        </div>
        <canvas id="gameBoard"></canvas>
    </div>

    <script>
        let canvas, ctx, cellW, cellH, rows = 20, cols = 30, boardData, selected = [];
        let images = [], timeLeft = 300, score = 0, timerInterval, gameStarted = false, paused = false;

        // Thêm hiệu ứng sparkle
        function createSparkle() {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.style.left = Math.random() * window.innerWidth + 'px';
            sparkle.style.top = Math.random() * window.innerHeight + 'px';
            sparkle.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(sparkle);

            setTimeout(() => {
                sparkle.remove();
            }, 1500);
        }

        // Tạo sparkle định kỳ
        setInterval(createSparkle, 500);

        function handleResponse(response) {
            if (!response.ok) throw new Error('HTTP ' + response.status);
            // always read as text first so we can show raw text on JSON error
            return response.text().then(text => {
                const contentType = response.headers.get('content-type') || '';
                // nếu server không báo json, log nguyên văn
                if (!contentType.includes('application/json')) {
                    console.error('Response content-type not JSON. Raw response:\n', text);
                    throw new Error('Invalid JSON (wrong content-type). See console for raw response.');
                }
                try {
                    // cố parse JSON và trả về object
                    return JSON.parse(text);
                } catch (err) {
                    // **Important**: show the full raw response so bạn biết chính xác server trả gì
                    console.error('Failed to parse JSON. Raw response (first 2000 chars):\n', text.substring(0, 2000));
                    // cũng show vị trí lỗi nếu có
                    console.error('JSON parse error:', err);
                    throw err; // cho flow hiện tại bắt và hiển thị
                }
            });
        }

        function loadImages() {
            images = []; // Reset mảng ảnh
            let loaded = 0;
            for (let i = 1; i <= 60; i++) {
                const img = new Image();
                img.src = `images/${i}.png`;
                img.onload = () => {
                    loaded++;
                    console.log(`Image ${i}.png loaded`);
                    if (loaded === 60 && boardData) drawBoard(); // Vẽ khi tất cả ảnh load xong và có boardData
                };
                img.onerror = () => {
                    console.error(`Failed to load ${i}.png`);
                    loaded++; // Tăng loaded ngay cả khi lỗi
                    if (loaded === 60 && boardData) drawBoard();
                };
                images.push(img);
            }
        }

        function drawBoard() {
            if (!canvas || !boardData || images.length === 0) {
                console.error('Error: No board data or images');
                return;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.lineWidth = 1;

            // Vẽ lưới với hiệu ứng gradient
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 0.1)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0.3)');
            ctx.strokeStyle = gradient;

            for (let i = 0; i <= rows; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * cellH);
                ctx.lineTo(canvas.width, i * cellH);
                ctx.stroke();
            }
            for (let j = 0; j <= cols; j++) {
                ctx.beginPath();
                ctx.moveTo(j * cellW, 0);
                ctx.lineTo(j * cellW, canvas.height);
                ctx.stroke();
            }

            // Vẽ ảnh với khung và hiệu ứng mờ/khung nổi bật
            const lines = boardData.split('\n').filter(line => line.trim());
            if (lines.length !== rows) {
                console.error('Error: Invalid board data format');
                return;
            }
            for (let i = 0; i < rows; i++) {
                const cells = lines[i].trim().split(/\s+/).map(cell => cell.trim()).filter(cell => cell !== '');
                if (cells.length !== cols) {
                    console.error('Error: Invalid column count');
                    return;
                }
                for (let j = 0; j < cols; j++) {
                    const val = parseInt(cells[j]);
                    if (val > 0 && val <= images.length) {
                        ctx.save();
                        ctx.translate(j * cellW, i * cellH);
                        const padding = 2;
                        const imgSize = cellW - 2 * padding;
                        if (selected.includes(`${i},${j}`)) {
                            // Hiệu ứng glow và khung gradient
                            ctx.globalAlpha = 0.5;
                            const glowGradient = ctx.createRadialGradient(cellW / 2, cellH / 2, 0, cellW / 2, cellH / 2, cellW / 2);
                            glowGradient.addColorStop(0, 'rgba(255, 215, 0, 0.8)');
                            glowGradient.addColorStop(1, 'rgba(255, 0, 150, 0.8)');
                            ctx.strokeStyle = glowGradient;
                            ctx.lineWidth = 4;
                            ctx.strokeRect(padding - 2, padding - 2, imgSize + 4, imgSize + 4);
                        } else if (val === 0) {
                            ctx.fillStyle = 'rgba(135, 206, 235, 0.3)';
                            ctx.fillRect(0, 0, cellW, cellH);
                        }
                        if (val > 0) {
                            // Thêm shadow cho ảnh
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                            ctx.shadowBlur = 5;
                            ctx.shadowOffsetX = 2;
                            ctx.shadowOffsetY = 2;
                            ctx.drawImage(images[val - 1], padding, padding, imgSize, imgSize);
                            ctx.shadowColor = 'transparent';
                        }
                        ctx.restore();
                    }
                }
            }
            console.log('Board drawn successfully');
        }

        function initGame() {
            canvas = document.getElementById('gameBoard');
            canvas.width = cols * 25;
            canvas.height = rows * 25;
            cellW = canvas.width / cols;
            cellH = canvas.height / rows;
            ctx = canvas.getContext('2d');
            canvas.onclick = handleClick;
            selected = [];
            loadImages(); // Load ảnh khi vào trang
            fetch('api.aspx', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `action=generate&rows=${rows}&cols=${cols}`
            })
                .then(handleResponse)
                .then(data => {
                    if (data.success) {
                        boardData = data.newBoard;
                        drawBoard();
                    } else {
                        alert(data.message);
                    }
                    // ✅ Reset selection bất kể đúng hay sai
                    selected = [];
                })
                .catch(err => {
                    console.error("Check match error:", err);
                    selected = []; // reset luôn nếu có lỗi
                });
        }

        function startGame() {
            if (gameStarted || paused) return;
            gameStarted = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            timeLeft = 300;
            score = 0;
            document.getElementById('timer').innerHTML = `⏰ Thời gian: ${timeLeft}s`;
            document.getElementById('score').innerHTML = `🎯 Điểm: ${score}`;
            selected = [];
            startTimer();
            drawBoard(); // Vẽ khi bắt đầu
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (gameStarted && !paused) {
                    timeLeft--;
                    document.getElementById('timer').innerHTML = `⏰ Thời gian: ${timeLeft}s`;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert('🎉 Hết thời gian! Điểm: ' + score);
                        gameStarted = false;
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('pauseBtn').disabled = true;
                    }
                }
            }, 1000);
        }

        function pauseGame() {
            if (!gameStarted) return;
            paused = !paused;
            document.getElementById('pauseBtn').innerHTML = paused ? '<span>Tiếp tục</span>' : '<span>Tạm dừng</span>';
        }

        function handleClick(event) {
            if (!canvas || !boardData || images.length === 0 || !gameStarted || paused || timeLeft <= 0) {
                console.log('Click ignored: Game not started, paused, no data, or time up');
                return;
            }
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const col = Math.floor(x / cellW);
            const row = Math.floor(y / cellH);

            console.log('Click at row:', row, 'col:', col);

            if (row >= 0 && row < rows && col >= 0 && col < cols) {
                const pos = `${row},${col}`;
                const lines = boardData.split('\n').filter(line => line.trim());
                const cells = lines[row].trim().split(/\s+/).map(cell => cell.trim()).filter(cell => cell !== '');
                const val = parseInt(cells[col]);
                if (selected.length < 2 && val > 0 && val <= images.length) {
                    selected.push(pos);
                    drawBoard();
                    console.log('Selected:', selected);
                    if (selected.length === 2) {
                        checkMatch();
                    }
                } else {
                    console.log('Invalid click: val =', val);
                }
            }
        }

        function checkMatch() {
            if (selected.length !== 2) return;
            const [pos1, pos2] = selected;
            const [r1, c1] = pos1.split(',').map(Number);
            const [r2, c2] = pos2.split(',').map(Number);

            console.log('Checking match:', r1, c1, r2, c2);

            // Gửi boardData để server cập nhật
            const boardStr = encodeURIComponent(boardData.replace(/\r/g, ""));

            fetch('api.aspx', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `action=check&r1=${r1}&c1=${c1}&r2=${r2}&c2=${c2}&board=${boardStr}`
            })
                .then(handleResponse)
                .then(data => {
                    console.log('Match result:', data);
                    if (data.success) {
                        score += 10;
                        document.getElementById('score').innerHTML = `🎯 Điểm: ${score}`;
                        boardData = data.newBoard; // Cập nhật từ server
                        selected = [];
                        drawBoard();
                    } else {
                        setTimeout(() => { selected = []; drawBoard(); }, 1000);
                    }
                })
                .catch(error => {
                    console.error('Check match error:', error);
                });
        }

        function restartGame() {
            gameStarted = false;
            paused = false;
            clearInterval(timerInterval);
            timeLeft = 300;
            score = 0;
            document.getElementById('timer').innerHTML = `⏰ Thời gian: ${timeLeft}s`;
            document.getElementById('score').innerHTML = `🎯 Điểm: ${score}`;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('pauseBtn').innerHTML = '<span>Tạm dừng</span>';
            selected = [];
            loadImages(); // Load ảnh ngay lập tức
            fetch('api.aspx', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `action=generate&rows=${rows}&cols=${cols}`
            })
                .then(handleResponse)
                .then(data => {
                    if (data.success) {
                        boardData = data.newBoard;
                        drawBoard();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Restart fetch error:', error);
                });
        }

        window.onload = initGame;
    </script>
</body>
</html>